#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "cjson/cJSON.h"

void write_to_csv(const char *filename, const char *tipo_de_dato, const char *dato) {
    FILE *file = fopen("output.csv", "a");
    if (!file) {
        perror("Error opening file");
        return;
    }
    fprintf(file, "%s,%s,%s\n", filename, tipo_de_dato, dato);
    fclose(file);
}

void parse_json_and_write_to_csv(const char *json_str) {
    cJSON *json = cJSON_Parse(json_str);
    if (!json) {
        printf("Error parsing JSON\n");
        return;
    }

    cJSON *archivos = cJSON_GetObjectItem(json, "archivos");
    if (!cJSON_IsArray(archivos)) {
        printf("Invalid JSON format\n");
        cJSON_Delete(json);
        return;
    }

    cJSON *archivo;
    cJSON_ArrayForEach(archivo, archivos) {
        cJSON *nombre_archivo = cJSON_GetObjectItem(archivo, "nombre_archivo");
        cJSON *datos = cJSON_GetObjectItem(archivo, "datos_extraidos");

        if (cJSON_IsString(nombre_archivo) && cJSON_IsArray(datos)) {
            cJSON *dato;
            cJSON_ArrayForEach(dato, datos) {
                cJSON *tipo = cJSON_GetObjectItem(dato, "tipo_de_dato");
                cJSON *contenido = cJSON_GetObjectItem(dato, "dato");

                if (cJSON_IsString(tipo) && cJSON_IsString(contenido)) {
                    write_to_csv(nombre_archivo->valuestring, tipo->valuestring, contenido->valuestring);
                }
            }
        }
    }

    cJSON_Delete(json);
}

int main() {

	FILE *fp1;
	char buffer[100000];
	static char json_data[100000];
	
	fp1 = open("venv/bin/python3 dataExtraction.py ./textFiles/'LS 0070 N_text.txt'");
	if(fp1 == NULL)
	{
		perror("ERROR OPENING PIPE");
		exit(1);
	}

	while(fgets(buffer, sizeof(buffer), fp) != NULL){
		strncat(json_data, buffer,100000 - strlen(json_data) - 1);
	}

	pclose(fp1);
	
	FILE *file = fopen("output.csv", "w");
    	if (file) {
        	fprintf(file, "nombre_archivo,tipo_de_dato,dato\n");
        	fclose(file);
    	}
    
    	parse_json_and_write_to_csv(json_data);
    	printf("Data written to output.csv successfully!\n");
   	return 0;
}
